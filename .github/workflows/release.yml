name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine tag
        id: tag
        run: |
          TAG=$(git tag --sort=-v:refname | head -n1)
          if [ -z "$TAG" ]; then TAG="v0.0.1-alpha"; fi
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then TAG="${{ github.ref_name }}"; fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          gh release view "$TAG" --repo ${{ github.repository }} >/dev/null 2>&1 || gh release create "$TAG" -t "$TAG" -n "Auto release" --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ github.token }}

  build:
    needs: create-release
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact: korlang
            asset_ext: tar.gz
            llvm_prefix: '/usr/lib/llvm-16'
          - os: windows-latest
            platform: windows
            artifact: korlang.exe
            asset_ext: zip
          - os: macos-latest
            platform: macos
            artifact: korlang
            asset_ext: tar.gz
            llvm_prefix: ''

    steps:
      - uses: actions/checkout@v4
        with:
          repository: Project-Korlang/Korlang-Compiler
          path: compiler

      - uses: dtolnay/rust-toolchain@stable

      - name: Install LLVM (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-16-dev libclang-16-dev libpolly-16-dev

      - name: Install LLVM (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install llvm@16

      - name: Install LLVM (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install llvm --version=16.0.6 -y --allow-downgrade
          
          # Find where it actually is
          $llvmPath = "C:\Program Files\LLVM"
          if (-not (Test-Path "$llvmPath\bin\llvm-config.exe")) {
              Write-Host "Searching for llvm-config.exe..."
              $found = Get-ChildItem -Path C:\ -Filter "llvm-config.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) {
                  $llvmPath = $found.Directory.Parent.FullName
                  Write-Host "Found LLVM at $llvmPath"
              }
          }
          
          Write-Host "Setting LLVM_SYS_160_PREFIX to $llvmPath"
          "$llvmPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "LLVM_SYS_160_PREFIX=$llvmPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Verify LLVM (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $config = Get-Command llvm-config -ErrorAction SilentlyContinue
          if ($config) {
              Write-Host "llvm-config found at: $($config.Source)"
              llvm-config --version
          } else {
              Write-Host "llvm-config NOT in PATH. Checking env var..."
              if (Test-Path "$env:LLVM_SYS_160_PREFIX\bin\llvm-config.exe") {
                  & "$env:LLVM_SYS_160_PREFIX\bin\llvm-config.exe" --version
              } else {
                  Write-Host "Could not find llvm-config.exe anywhere!"
                  ls "C:\Program Files\LLVM" -Recurse
                  exit 1
              }
          }

      - name: Build Runtime
        shell: bash
        run: |
          cd compiler/src/runtime
          cargo build --release

      - name: Build CLI
        shell: bash
        run: |
          # Use the environment variable set by the previous step
          cd compiler/src/tools/cli
          cargo build --release

      - name: Package (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist/bin dist/lib
          cp compiler/src/tools/cli/target/release/korlang dist/bin/
          cp compiler/src/runtime/target/release/libkorlang_rt.a dist/lib/
          TAG="${{ needs.create-release.outputs.tag }}"
          VERSION="${TAG#v}"
          tar -czf "korlang-${TAG}-${{ matrix.platform }}-x86_64.tar.gz" -C dist .
          cp "korlang-${TAG}-${{ matrix.platform }}-x86_64.tar.gz" "korlang-${VERSION}-${{ matrix.platform }}-x86_64.tar.gz"

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist\bin
          New-Item -ItemType Directory -Force -Path dist\lib
          Copy-Item compiler\src\tools\cli\target\release\korlang.exe dist\bin\
          if (Test-Path "compiler\src\runtime\target\release\korlang_rt.lib") {
            Copy-Item "compiler\src\runtime\target\release\korlang_rt.lib" dist\lib\
          } elseif (Test-Path "compiler\src\runtime\target\release\libkorlang_rt.a") {
            Copy-Item "compiler\src\runtime\target\release\libkorlang_rt.a" dist\lib\
          }
          $TAG="${{ needs.create-release.outputs.tag }}"
          $VERSION=$TAG.TrimStart('v')
          Compress-Archive -Path dist\* -DestinationPath "korlang-$TAG-windows-x86_64.zip"
          # Explicitly target the zip for copying to avoid errors if it is locked or not found
          $zipPath = "korlang-$TAG-windows-x86_64.zip"
          if (Test-Path $zipPath) {
            Copy-Item $zipPath "korlang-$VERSION-windows-x86_64.zip"
          }

      - name: Upload Assets
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ needs.create-release.outputs.tag }}"
          VERSION="${TAG#v}"
          gh release upload "$TAG" korlang-${TAG}-${{ matrix.platform }}-x86_64.${{ matrix.asset_ext }} --clobber --repo ${{ github.repository }}
          gh release upload "$TAG" korlang-${VERSION}-${{ matrix.platform }}-x86_64.${{ matrix.asset_ext }} --clobber --repo ${{ github.repository }}
