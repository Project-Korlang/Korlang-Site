name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine latest tag
        id: tag
        run: |
          TAG=$(git tag --sort=-v:refname | head -n1)
          if [ -z "$TAG" ]; then
            TAG="v0.0.1-alpha"
            git tag "$TAG"
            git push origin "$TAG"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        with:
          repository: Project-Korlang/Korlang-Compiler
          path: compiler

      - uses: dtolnay/rust-toolchain@stable

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-16 llvm-16-dev clang lld zip libpolly-16-dev

      - name: Build runtime
        run: |
          cd compiler/src/runtime
          cargo build --release

      - name: Build CLI
        env:
          LLVM_SYS_160_PREFIX: /usr/lib/llvm-16
          LLVM_SYS_160_NO_Polly: 1
        run: |
          cd compiler/src/tools/cli
          cargo build --release

      - name: Package release assets
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          VERSION="${TAG#v}"
          rm -rf dist
          mkdir -p dist/korlang/bin dist/korlang/lib
          cp compiler/src/tools/cli/target/release/korlang dist/korlang/bin/
          cp compiler/src/runtime/target/release/libkorlang_rt.a dist/korlang/lib/
          tar -czf "dist/korlang-${TAG}-linux-x86_64.tar.gz" -C dist korlang
          cp "dist/korlang-${TAG}-linux-x86_64.tar.gz" "dist/korlang-${TAG}-macos-x86_64.tar.gz"
          zip -j "dist/korlang-${TAG}-windows-x86_64.zip" dist/korlang/bin/korlang dist/korlang/lib/libkorlang_rt.a
          # New format assets (version without leading 'v')
          cp "dist/korlang-${TAG}-linux-x86_64.tar.gz" "dist/korlang-${VERSION}-linux-x86_64.tar.gz"
          cp "dist/korlang-${TAG}-macos-x86_64.tar.gz" "dist/korlang-${VERSION}-macos-x86_64.tar.gz"
          cp "dist/korlang-${TAG}-windows-x86_64.zip" "dist/korlang-${VERSION}-windows-x86_64.zip"
          sha256sum dist/korlang-* > dist/korlang-${TAG}-checksums.txt
          cat > dist/korlang-${TAG}-manifest.json <<JSON
          {
            "tag": "${TAG}",
            "version": "${VERSION}",
            "assets": [
              "korlang-${TAG}-linux-x86_64.tar.gz",
              "korlang-${TAG}-macos-x86_64.tar.gz",
              "korlang-${TAG}-windows-x86_64.zip",
              "korlang-${VERSION}-linux-x86_64.tar.gz",
              "korlang-${VERSION}-macos-x86_64.tar.gz",
              "korlang-${VERSION}-windows-x86_64.zip",
              "korlang-${TAG}-checksums.txt"
            ]
          }
          JSON

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" -t "$TAG" -n "Auto release"
          gh release upload "$TAG" \
            dist/korlang-*-linux-x86_64.tar.gz \
            dist/korlang-*-macos-x86_64.tar.gz \
            dist/korlang-*-windows-x86_64.zip \
            dist/korlang-${TAG}-checksums.txt \
            dist/korlang-${TAG}-manifest.json \
            --clobber
