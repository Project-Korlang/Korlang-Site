name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine tag
        id: tag
        run: |
          TAG=$(git tag --sort=-v:refname | head -n1)
          if [ -z "$TAG" ]; then TAG="v0.0.1-alpha"; fi
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then TAG="${{ github.ref_name }}"; fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          gh release view "$TAG" --repo ${{ github.repository }} >/dev/null 2>&1 || gh release create "$TAG" -t "$TAG" -n "Auto release" --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ github.token }}

  build:
    needs: create-release
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact: korlang
            asset_ext: tar.gz
            llvm_prefix: '/usr/lib/llvm-16'
          - os: windows-latest
            platform: windows
            artifact: korlang.exe
            asset_ext: zip
            llvm_prefix: ''
          - os: macos-latest
            platform: macos
            artifact: korlang
            asset_ext: tar.gz
            llvm_prefix: ''

    steps:
      - uses: actions/checkout@v4
        with:
          repository: Project-Korlang/Korlang-Compiler
          path: compiler

      - uses: dtolnay/rust-toolchain@stable

      - name: Install LLVM (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-16-dev libclang-16-dev libpolly-16-dev

      - name: Install LLVM (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install llvm@16

      - name: Install LLVM (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install llvm --version=16.0.6 -y

      - name: Build Runtime
        shell: bash
        run: |
          cd compiler/src/runtime
          cargo build --release

      - name: Build CLI
        shell: bash
        env:
          LLVM_SYS_160_PREFIX: ${{ matrix.llvm_prefix }}
        run: |
          cd compiler/src/tools/cli
          cargo build --release

      - name: Package (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist/bin dist/lib
          cp compiler/src/tools/cli/target/release/korlang dist/bin/
          cp compiler/src/runtime/target/release/libkorlang_rt.a dist/lib/
          TAG="${{ needs.create-release.outputs.tag }}"
          VERSION="${TAG#v}"
          tar -czf "korlang-${TAG}-${{ matrix.platform }}-x86_64.tar.gz" -C dist .
          cp "korlang-${TAG}-${{ matrix.platform }}-x86_64.tar.gz" "korlang-${VERSION}-${{ matrix.platform }}-x86_64.tar.gz"

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist\bin
          New-Item -ItemType Directory -Force -Path dist\lib
          Copy-Item compiler\src\tools\cli\target\release\korlang.exe dist\bin\
          Copy-Item compiler\src\runtime\target\release\korlang_rt.lib dist\lib\
          $TAG="${{ needs.create-release.outputs.tag }}"
          $VERSION=$TAG.TrimStart('v')
          Compress-Archive -Path dist\* -DestinationPath "korlang-$TAG-windows-x86_64.zip"
          Copy-Item "korlang-$TAG-windows-x86_64.zip" "korlang-$VERSION-windows-x86_64.zip"

      - name: Upload Assets
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ needs.create-release.outputs.tag }}"
          VERSION="${TAG#v}"
          gh release upload "$TAG" korlang-${TAG}-${{ matrix.platform }}-x86_64.${{ matrix.asset_ext }} --clobber --repo ${{ github.repository }}
          gh release upload "$TAG" korlang-${VERSION}-${{ matrix.platform }}-x86_64.${{ matrix.asset_ext }} --clobber --repo ${{ github.repository }}
