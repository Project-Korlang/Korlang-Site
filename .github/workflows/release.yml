name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine tag
        id: tag
        run: |
          TAG=$(git tag --sort=-v:refname | head -n1)
          if [ -z "$TAG" ]; then TAG="v0.0.1-alpha"; fi
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then TAG="${{ github.ref_name }}"; fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          gh release view "$TAG" --repo ${{ github.repository }} >/dev/null 2>&1 || gh release create "$TAG" -t "$TAG" -n "Auto release" --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ github.token }}

  build:
    needs: create-release
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact: korlang
            asset_ext: tar.gz
            llvm_prefix: '/usr/lib/llvm-16'
          - os: windows-latest
            platform: windows
            artifact: korlang.exe
            asset_ext: zip
          - os: macos-latest
            platform: macos
            artifact: korlang
            asset_ext: tar.gz
            llvm_prefix: ''

    steps:
      - uses: actions/checkout@v4
        with:
          repository: Project-Korlang/Korlang-Compiler
          path: compiler

      - uses: dtolnay/rust-toolchain@stable

      - name: Install LLVM (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-16-dev libclang-16-dev libpolly-16-dev

      - name: Install LLVM (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install llvm@16

      - name: Setup MSVC (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install LLVM (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install llvm --version=16.0.6 -y --allow-downgrade --no-progress
          $originalPath = "C:\Program Files\LLVM"
          if (!(Test-Path $originalPath)) { $originalPath = "C:\Program Files (x86)\LLVM" }
          
          # Create a junction to avoid space issues in paths
          $llvmPath = "C:\LLVM"
          if (Test-Path $llvmPath) { Remove-Item $llvmPath -Recurse -Force }
          New-Item -ItemType Junction -Path $llvmPath -Target $originalPath
          
          # Use Add-Content for more reliable environment export
          Add-Content -Path $env:GITHUB_ENV -Value "LLVM_SYS_160_PREFIX=C:/LLVM"
          Add-Content -Path $env:GITHUB_ENV -Value "LLVM_CONFIG=C:/LLVM/bin/llvm-config.exe"
          Add-Content -Path $env:GITHUB_PATH -Value "C:/LLVM/bin"
          Add-Content -Path $env:GITHUB_ENV -Value "LIB=C:/LLVM/lib;$env:LIB"
          
          # Force use of lld-link to avoid link.exe conflicts
          Add-Content -Path $env:GITHUB_ENV -Value "RUSTFLAGS=-C linker=lld-link"
          Add-Content -Path $env:GITHUB_ENV -Value "CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_LINKER=lld-link"

      - name: Build Runtime (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        env:
          LLVM_SYS_160_PREFIX: C:/LLVM
          LLVM_CONFIG: C:/LLVM/bin/llvm-config.exe
        run: |
          ls C:\LLVM\bin\llvm-config.exe
          cd compiler/src/runtime
          cargo build --release

      - name: Build CLI (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        env:
          LLVM_SYS_160_PREFIX: C:/LLVM
          LLVM_CONFIG: C:/LLVM/bin/llvm-config.exe
        run: |
          ls C:\LLVM\bin\llvm-config.exe
          cd compiler/src/tools/cli
          cargo build --release

      - name: Build (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          cd compiler/src/runtime && cargo build --release
          cd ../../../
          cd compiler/src/tools/cli && cargo build --release

      - name: Package (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist/bin dist/lib dist/stdlib
          cp compiler/target/release/korlang dist/bin/
          cp compiler/target/release/libkorlang_rt.a dist/lib/
          # Use find to avoid broken symlinks
          cd compiler/src/stdlib && find . -type f -o -type d | cpio -pdm ../../../dist/stdlib/ 2>/dev/null || true
          cd ../../..
          TAG="${{ needs.create-release.outputs.tag }}"
          tar -czf "korlang-${TAG}-${{ matrix.platform }}-x86_64.tar.gz" -C dist .

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist\bin, dist\lib, dist\stdlib
          Copy-Item compiler\target\release\korlang.exe dist\bin\
          Copy-Item -Path compiler\src\stdlib\* -Destination dist\stdlib\ -Recurse -Force
          if (Test-Path "compiler\target\release\korlang_rt.lib") {
            Copy-Item "compiler\target\release\korlang_rt.lib" dist\lib\
          } elseif (Test-Path "compiler\target\release\libkorlang_rt.a") {
            # Some environments might produce .a instead of .lib even on Windows with gnu toolchain
            Copy-Item "compiler\target\release\libkorlang_rt.a" dist\lib\korlang_rt.lib
          }
          $TAG="${{ needs.create-release.outputs.tag }}"
          Compress-Archive -Path dist\* -DestinationPath "korlang-$TAG-windows-x86_64.zip"

      - name: Upload Assets
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ needs.create-release.outputs.tag }}"
          gh release upload "$TAG" korlang-${TAG}-${{ matrix.platform }}-x86_64.${{ matrix.asset_ext }} --clobber --repo ${{ github.repository }}
