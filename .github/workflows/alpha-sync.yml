name: Alpha Sync From Compiler

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
  repository_dispatch:
    types: [compiler-updated]

permissions:
  contents: write

concurrency:
  group: alpha-sync
  cancel-in-progress: false

jobs:
  # Check if we actually need to build anything
  check-version:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      sha: ${{ steps.compiler.outputs.sha }}
      short: ${{ steps.compiler.outputs.short }}
    steps:
      - name: Resolve latest compiler commit
        id: compiler
        run: |
          SHA=$(git ls-remote https://github.com/Project-Korlang/Korlang-Compiler.git refs/heads/main | awk '{print $1}')
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "short=$(echo $SHA | cut -c1-12)" >> "$GITHUB_OUTPUT"

      - name: Check current alpha release marker
        id: check
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          TAG="alpha-latest"
          BODY="$(gh release view "$TAG" --json body --jq .body 2>/dev/null || true)"
          if echo "$BODY" | grep -q "compiler_sha=${{ steps.compiler.outputs.sha }}"; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

  # Build native binaries for each OS
  build:
    needs: check-version
    if: needs.check-version.outputs.changed == 'true'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            extension: tar.gz
          - os: macos-latest
            platform: macos
            extension: tar.gz
          - os: windows-latest
            platform: windows
            extension: zip
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: Project-Korlang/Korlang-Compiler
          ref: ${{ needs.check-version.outputs.sha }}

      - uses: dtolnay/rust-toolchain@stable

      - name: Install LLVM (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-16 llvm-16-dev clang lld libpolly-16-dev
          echo "LLVM_SYS_160_PREFIX=/usr/lib/llvm-16" >> $GITHUB_ENV

      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install LLVM (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install llvm --version=16.0.6 --no-progress --allow-downgrade --force --yes
          $llvmPath = "C:\Program Files\LLVM"
          if (!(Test-Path $llvmPath)) {
            $llvmPath = "C:\Program Files (x86)\LLVM"
          }
          if (!(Test-Path $llvmPath)) {
            throw "LLVM 16.0.6 not found at $llvmPath"
          }
          
          # Use Add-Content for more reliable environment variable export
          Add-Content -Path $env:GITHUB_ENV -Value "LLVM_SYS_160_PREFIX=$llvmPath"
          Add-Content -Path $env:GITHUB_PATH -Value "$llvmPath\bin"
          Add-Content -Path $env:GITHUB_ENV -Value "LIB=$llvmPath\lib;$env:LIB"
          
          # Avoid PATH conflict with Git's Unix link.exe without nuking the whole usr/bin
          # Instead of replacing PATH, we've prepended LLVM/bin and MSVC will be prepended too.
          # We force lld-link to be safer.
          Add-Content -Path $env:GITHUB_ENV -Value "RUSTFLAGS=-C linker=lld-link"
          Add-Content -Path $env:GITHUB_ENV -Value "CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_LINKER=lld-link"

      - name: Install LLVM (macOS)
        if: runner.os == 'macOS'
        run: brew install llvm@16

      - name: Build (All Platforms)
        shell: bash
        run: |
          cd src/runtime && cargo build --release
          cd ../tools/cli && cargo build --release

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist/korlang/bin dist/korlang/lib dist/korlang/stdlib
          cp target/release/korlang dist/korlang/bin/
          cp target/release/libkorlang_rt.a dist/korlang/lib/
          # Use find to avoid broken symlinks
          cd src/stdlib && find . -type f -o -type d | cpio -pdm ../../dist/korlang/stdlib/ 2>/dev/null || true
          cd ../..
          tar -czf "korlang-alpha-latest-${{ matrix.platform }}-x86_64.tar.gz" -C dist korlang

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist/korlang/bin, dist/korlang/lib, dist/korlang/stdlib -Force
          Copy-Item target/release/korlang.exe dist/korlang/bin/
          Copy-Item -Path src/stdlib/* -Destination dist/korlang/stdlib/ -Recurse -Force
          if (Test-Path "target/release/korlang_rt.lib") {
            Copy-Item "target/release/korlang_rt.lib" dist/korlang/lib/
          } else {
            Copy-Item "target/release/libkorlang_rt.a" dist/korlang/lib/korlang_rt.lib
          }
          Compress-Archive -Path dist/korlang/* -DestinationPath "korlang-alpha-latest-windows-x86_64.zip"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: korlang-${{ matrix.platform }}
          path: korlang-alpha-latest-*

  # Finalize the release by attaching all binaries
  publish:
    needs: [check-version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all-assets
          merge-multiple: true

      - name: Update Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          TAG="alpha-latest"
          TITLE="alpha-latest (${{ needs.check-version.outputs.short }})"
          BODY=$'Rolling alpha build.\n\ncompiler_sha=${{ needs.check-version.outputs.sha }}'
          
          gh release view "$TAG" || gh release create "$TAG" --prerelease -t "$TITLE" -n "$BODY"
          gh release edit "$TAG" -t "$TITLE" -n "$BODY"
          gh release upload "$TAG" all-assets/* --clobber
